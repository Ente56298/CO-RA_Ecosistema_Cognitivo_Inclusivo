# Makefile - Pipeline Automatizado CO-RA
# GeneraciÃ³n de videos y gestiÃ³n de eventos de streaming

.PHONY: video event deploy clean help

# Variables por defecto
SUJETO ?= sueldos_morelos
DATOS ?= content/$(SUJETO)/data/datos.csv
GUION ?= content/$(SUJETO)/scripts/guion.md
BROLL ?= content/$(SUJETO)/broll/clip1.mp4
MUSIC ?= content/$(SUJETO)/music/track.mp3

# Comando principal: generar video completo
video:
	@echo "ğŸš€ Generando video: $(SUJETO)"
	@echo "ğŸ“Š Datos: $(DATOS)"
	@echo "ğŸ“ Guion: $(GUION)"
	
	# Verificar archivos requeridos
	@test -f $(DATOS) || (echo "âŒ Error: $(DATOS) no encontrado" && exit 1)
	@test -f $(GUION) || (echo "âŒ Error: $(GUION) no encontrado" && exit 1)
	
	# Generar grÃ¡ficos
	@echo "ğŸ“Š Generando grÃ¡ficos..."
	python3 scripts/build_charts.py $(DATOS) content/$(SUJETO)/out
	
	# Generar subtÃ­tulos
	@echo "ğŸ“ Generando subtÃ­tulos..."
	python3 scripts/md_to_srt.py $(GUION) content/$(SUJETO)/out/subs.srt
	
	# Renderizar video
	@echo "ğŸ¬ Renderizando video..."
	bash scripts/render_video.sh $(SUJETO) $(BROLL) $(MUSIC)
	
	# Generar assets de publicaciÃ³n
	@echo "ğŸ“± Generando assets de publicaciÃ³n..."
	$(MAKE) publish-assets SUJETO=$(SUJETO)
	
	@echo "âœ… Video completado: content/$(SUJETO)/out/video_final.mp4"

# Generar assets para publicaciÃ³n
publish-assets:
	@echo "ğŸ“± Generando tÃ­tulo y descripciÃ³n..."
	@echo "# $(shell echo $(SUJETO) | tr '_' ' ' | sed 's/.*/\L&/; s/[a-z]*/\u&/g')" > content/$(SUJETO)/out/titulo.txt
	@echo "Â¿Por quÃ© hay tanta diferencia? ğŸ“Š AnÃ¡lisis completo de datos oficiales." >> content/$(SUJETO)/out/titulo.txt
	
	@echo "ğŸ“‹ Generando descripciÃ³n..."
	@echo "ğŸ” AnÃ¡lisis detallado de $(shell echo $(SUJETO) | tr '_' ' ')" > content/$(SUJETO)/out/descripcion.txt
	@echo "ğŸ“Š Datos oficiales y verificados" >> content/$(SUJETO)/out/descripcion.txt
	@echo "ğŸ’¡ Insights y conclusiones clave" >> content/$(SUJETO)/out/descripcion.txt
	@echo "" >> content/$(SUJETO)/out/descripcion.txt
	@echo "ğŸ”— MÃ¡s anÃ¡lisis en: tu-sitio.com" >> content/$(SUJETO)/out/descripcion.txt
	@echo "" >> content/$(SUJETO)/out/descripcion.txt
	@echo "#$(shell echo $(SUJETO) | tr '_' ' ' | sed 's/ //g') #Datos #AnÃ¡lisis #Transparencia" >> content/$(SUJETO)/out/descripcion.txt

# Crear evento de streaming
event:
	@echo "ğŸª Creando evento de streaming..."
	@test -n "$(EVENT)" || (echo "âŒ Error: Especifica EVENT=nombre_evento" && exit 1)
	bash tenancingo_live/scripts/create_event.sh $(EVENT)

# Desplegar infraestructura
deploy:
	@echo "ğŸš€ Desplegando infraestructura..."
	cd tenancingo_live && docker-compose up -d
	@echo "âœ… Servicios desplegados:"
	@echo "   ğŸ“º RTMP: rtmp://localhost:1935/live"
	@echo "   ğŸŒ Web: http://localhost:8080"
	@echo "   ğŸ“¡ HLS: http://localhost:8081/hls/"

# Detener servicios
stop:
	@echo "ğŸ›‘ Deteniendo servicios..."
	cd tenancingo_live && docker-compose down

# Limpiar archivos temporales
clean:
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find content -name "*.tmp" -delete
	find content -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Limpieza completada"

# Configurar proyecto nuevo
setup:
	@echo "âš™ï¸  Configurando proyecto..."
	@test -n "$(PROYECTO)" || (echo "âŒ Error: Especifica PROYECTO=nombre" && exit 1)
	
	# Crear estructura
	mkdir -p content/$(PROYECTO)/{data,broll,music,out,scripts}
	
	# Crear archivos de ejemplo
	@echo "# Guion para $(PROYECTO)" > content/$(PROYECTO)/scripts/guion.md
	@echo "" >> content/$(PROYECTO)/scripts/guion.md
	@echo "IntroducciÃ³n al tema de $(PROYECTO)." >> content/$(PROYECTO)/scripts/guion.md
	@echo "Datos principales y hallazgos." >> content/$(PROYECTO)/scripts/guion.md
	@echo "Conclusiones y llamada a la acciÃ³n." >> content/$(PROYECTO)/scripts/guion.md
	
	@echo "puesto,salario" > content/$(PROYECTO)/data/datos.csv
	@echo "Ejemplo 1,25000" >> content/$(PROYECTO)/data/datos.csv
	@echo "Ejemplo 2,35000" >> content/$(PROYECTO)/data/datos.csv
	@echo "Ejemplo 3,45000" >> content/$(PROYECTO)/data/datos.csv
	
	@echo "âœ… Proyecto $(PROYECTO) configurado en content/$(PROYECTO)/"
	@echo "ğŸ“ Edita: content/$(PROYECTO)/scripts/guion.md"
	@echo "ğŸ“Š Edita: content/$(PROYECTO)/data/datos.csv"
	@echo "ğŸµ AÃ±ade: content/$(PROYECTO)/music/track.mp3"
	@echo "ğŸ¬ AÃ±ade: content/$(PROYECTO)/broll/clip1.mp4"

# Verificar dependencias
check:
	@echo "ğŸ” Verificando dependencias..."
	@command -v python3 >/dev/null 2>&1 || (echo "âŒ Python3 no encontrado" && exit 1)
	@command -v ffmpeg >/dev/null 2>&1 || (echo "âŒ FFmpeg no encontrado" && exit 1)
	@command -v docker >/dev/null 2>&1 || (echo "âŒ Docker no encontrado" && exit 1)
	@python3 -c "import pandas, matplotlib" 2>/dev/null || (echo "âŒ LibrerÃ­as Python faltantes: pip install pandas matplotlib" && exit 1)
	@echo "âœ… Todas las dependencias estÃ¡n instaladas"

# Ayuda
help:
	@echo "ğŸ¬ Pipeline Automatizado CO-RA"
	@echo "================================"
	@echo ""
	@echo "ğŸ“Š GENERACIÃ“N DE VIDEOS:"
	@echo "  make video SUJETO=nombre DATOS=archivo.csv GUION=guion.md"
	@echo "  make setup PROYECTO=nuevo_proyecto"
	@echo ""
	@echo "ğŸª STREAMING:"
	@echo "  make event EVENT=nombre_evento"
	@echo "  make deploy"
	@echo "  make stop"
	@echo ""
	@echo "ğŸ”§ UTILIDADES:"
	@echo "  make check    - Verificar dependencias"
	@echo "  make clean    - Limpiar archivos temporales"
	@echo "  make help     - Mostrar esta ayuda"
	@echo ""
	@echo "ğŸ“ ESTRUCTURA:"
	@echo "  content/SUJETO/data/     - CSV con datos"
	@echo "  content/SUJETO/scripts/  - Guion en Markdown"
	@echo "  content/SUJETO/broll/    - Video de fondo"
	@echo "  content/SUJETO/music/    - MÃºsica de fondo"
	@echo "  content/SUJETO/out/      - Archivos generados"